name: Combined Security and Code Analysis Workflows

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - '**/*.md'
  pull_request:
    branches:
      - master
      - main
    paths-ignore:
      - '**/*.md'
  workflow_dispatch:
    inputs:
      debug:
        type: boolean
        required: false
        default: false
  schedule:
    - cron: '0 0 * * 1'

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: read

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  # Grype job
  Grype:
    if: github.repository_owner == 'austinsonger'
    name: Grype
    uses: austinsonger/GitHubActions/.github/workflows/grype.yaml@master
    with:
      debug: ${{ github.event.inputs.debug }}

  # Semgrep job
  Semgrep:
    if: github.repository_owner == 'austinsonger'
    name: Semgrep GitHub Security Tab
    uses: austinsonger/GitHubActions/.github/workflows/semgrep.yaml@master
    with:
      debug: ${{ github.event.inputs.debug }}

  # Semgrep Cloud job
  SemgrepCloud:
    if: github.repository_owner == 'austinsonger'
    name: Semgrep Cloud
    uses: austinsonger/GitHubActions/.github/workflows/semgrep-cloud.yaml@master
    secrets:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    with:
      debug: ${{ github.event.inputs.debug }}

  # SonarCloud job
  SonarCloud:
    if: github.repository_owner == 'austinsonger'
    name: SonarCloud
    uses: austinsonger/GitHubActions/.github/workflows/sonarcloud.yaml@master
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Kics job
  Kics:
    if: github.repository_owner == 'austinsonger'
    name: Kics
    uses: austinsonger/GitHubActions/.github/workflows/kics.yaml@master
    with:
      debug: ${{ github.event.inputs.debug }}

  # Validation job
  Validation:
    if: github.repository_owner == 'austinsonger'
    name: Validate
    uses: austinsonger/GitHubActions/.github/workflows/validate.yaml@master
    with:
      debug: ${{ github.event.inputs.debug }}

  # Trivy job
  Trivy:
    if: github.repository_owner == 'austinsonger'
    name: Trivy
    uses: austinsonger/GitHubActions/.github/workflows/trivy.yaml@master
    with:
      debug: ${{ github.event.inputs.debug }}